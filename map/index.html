<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BucketMap - Map</title>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="spinner.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css">
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
</head>

<body>
    <header class="site-header">
        <div class="header-content">
            <h1>BucketMap</h1>
            <button id="menuToggle" class="menu-toggle">☰</button>
            <nav id="mainNav" class="nav-closed">
                <ul>
                    <li><a href="../">Home</a></li>
                    <li><a href="../map">Buckmap</a></li>
                    <li><a href="../aboutus">About Us</a></li>
                    <li><a href="../contactpage">Contact Page</a></li>
                    <li><a href="../login" id="loginLink">Login</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <main>
        <button id="controlsToggle" class="controls-toggle">☰ Show Controls</button>
        <div id="controls" class="controls controls-closed">
            <div class="filter-section">
                <h3>Filters</h3>
                <div class="filter-options">
                    <label>
                        <input type="checkbox" id="showBucketlist" checked>
                        Show Bucketlist Items
                    </label>
                    <label>
                        <input type="checkbox" id="showVisited" checked>
                        Show Visited Places
                    </label>
                </div>
            </div>
            <div class="bucketlist-section">
                <h3>My Bucketlist</h3>
                <div class="search-container">
                    <input type="text" id="bucketlistSearch" placeholder="Search locations..."
                        class="bucketlist-search">
                </div>
                <div id="bucketlistItems" class="bucketlist-items"></div>
            </div>
        </div>
        <div id="map"></div>
    </main>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyChQQiUKzxdvITadpBhMM4rryaNL4hLNaY",
            authDomain: "buckmap-83956.firebaseapp.com",
            projectId: "buckmap-83956",
            storageBucket: "buckmap-83956.firebasestorage.app",
            messagingSenderId: "809697568507",
            appId: "1:809697568507:web:b2e70b0f7a04837063f25e",
            measurementId: "G-4JD9LL21HT"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        let map;
        let markers = [];
        let allLocations = [];

        document.getElementById('menuToggle').addEventListener('click', () => {
            const nav = document.getElementById('mainNav');
            nav.classList.toggle('nav-closed');
            document.body.classList.toggle('nav-open', !nav.classList.contains('nav-closed'));
            const zoomControls = document.querySelector('.leaflet-control-zoom');
            if (zoomControls) {
                zoomControls.style.display = nav.classList.contains('nav-closed') ? 'block' : 'none';
                zoomControls.style.visibility = nav.classList.contains('nav-closed') ? 'visible' : 'hidden';
            }
        });

        document.getElementById('controlsToggle').addEventListener('click', () => {
            const controls = document.getElementById('controls');
            const button = document.getElementById('controlsToggle');
            controls.classList.toggle('controls-closed');
            button.textContent = controls.classList.contains('controls-closed') ? '☰ Show Controls' : '✕ Hide Controls';
        });

        firebase.auth().onAuthStateChanged((user) => {
            if (user) {
                document.getElementById('loginLink').textContent = 'Logout';
                document.getElementById('loginLink').addEventListener('click', (e) => {
                    e.preventDefault();
                    firebase.auth().signOut();
                });
                loadMap();
                setupFilters();
            } else {
                window.location.href = '../login';
            }
        });

        function loadMap() {
            map = L.map('map', {
                zoomControl: false,
                minZoom: 2,
                maxBounds: [[-90, -180], [90, 180]]
            }).setView([20, 0], 3);

            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                attribution: '©OpenStreetMap, ©CartoDB',
                subdomains: 'abcd',
                maxZoom: 19
            }).addTo(map);

            L.control.zoom({ position: 'topleft' }).addTo(map);
            loadLocations();
        }

        function loadLocations() {
            markers.forEach(marker => marker.remove());
            markers = [];

            const markerClusterGroup = L.markerClusterGroup();

            const showBucketlist = document.getElementById('showBucketlist').checked;
            const showVisited = document.getElementById('showVisited').checked;
            const userId = firebase.auth().currentUser.uid;
            const searchQuery = document.getElementById('bucketlistSearch').value.toLowerCase();

            db.collection('userVisits')
                .where('userId', '==', userId)
                .get()
                .then((visitSnapshot) => {
                    const visitedLocations = new Map();
                    visitSnapshot.forEach((visit) => {
                        visitedLocations.set(visit.data().locationId, visit.id);
                    });

                    return db.collection('locations').get().then((querySnapshot) => {
                        const bucketlistContainer = document.getElementById('bucketlistItems');
                        bucketlistContainer.innerHTML = '';
                        allLocations = [];

                        querySnapshot.forEach((doc) => {
                            const data = doc.data();
                            const isVisited = visitedLocations.has(doc.id);

                            allLocations.push({
                                id: doc.id,
                                name: data.name,
                                isVisited: isVisited,
                                data: data
                            });
                        });

                        const filteredLocations = allLocations.filter(location =>
                            location.name.toLowerCase().includes(searchQuery.toLowerCase())
                        );

                        filteredLocations.forEach(location => {
                            const data = location.data;
                            const isVisited = location.isVisited;
                            const markerColor = isVisited ? 'green' : 'blue';

                            if ((isVisited && showVisited) || (!isVisited && showBucketlist)) {
                                const marker = L.circleMarker([data.latitude, data.longitude], {
                                    color: markerColor,
                                    radius: 8
                                });
                                markerClusterGroup.addLayer(marker);
                                markers.push(marker);

                                marker.on('click', function (e) {
                                    const markerLatLng = e.target.getLatLng();
                                    const mapContainer = map.getContainer();

                                    const containerWidth = mapContainer.clientWidth;
                                    const containerHeight = mapContainer.clientHeight;

                                    const controlsWidth = document.getElementById('controls').classList.contains('controls-closed') ? 0 : 300;

                                    const targetPoint = map.project(markerLatLng, map.getZoom());
                                    const offsetX = (controlsWidth / 2) - (containerWidth / 2);
                                    const offsetY = -(containerHeight / 2);

                                    const newCenter = map.unproject([
                                        targetPoint.x + offsetX,
                                        targetPoint.y + offsetY
                                    ], map.getZoom());

                                    map.setView(newCenter, map.getZoom(), {
                                        animate: true,
                                        duration: 0.5
                                    });
                                });

                                marker.bindPopup(`
        <div class="marker-popup">
            <h3 class="popup-title">${data.name}</h3>
            <div class="popup-image-container">
                <img src="${data.imageUrl}" alt="${data.name}">
            </div>
            <p class="popup-status ${isVisited ? 'visited' : 'bucketlist'}">
                ${isVisited ? '✓ Visited' : '○ On Bucketlist'}
            </p>
            <button class="popup-button" onclick="toggleVisited('${location.id}', ${!isVisited})">
                Mark as ${isVisited ? 'Not Visited' : 'Visited'}
            </button>
        </div>
    `);

                                const itemDiv = document.createElement('div');
                                itemDiv.className = `bucketlist-item ${isVisited ? 'visited' : ''}`;
                                itemDiv.innerHTML = `
                                    <span class="location-name" data-lat="${data.latitude}" data-lng="${data.longitude}">${data.name}</span>
                                    <button onclick="toggleVisited('${location.id}', ${!isVisited})">
                                        ${isVisited ? '✓' : '○'}
                                    </button>
                                `;

                                const locationName = itemDiv.querySelector('.location-name');

                                locationName.addEventListener('click', () => {
                                    const lat = parseFloat(locationName.dataset.lat);
                                    const lng = parseFloat(locationName.dataset.lng);

                                    // Get current zoom level
                                    const currentZoom = map.getZoom();

                                    // First zoom out
                                    map.setZoom(currentZoom - 2, {
                                        animate: true,
                                        duration: 0.75
                                    });

                                    // After zooming out, fly to location and zoom in
                                    setTimeout(() => {
                                        map.flyTo([lat, lng], 13, {
                                            animate: true,
                                            duration: 1.5,
                                            easeLinearity: 0.25
                                        });
                                    });
                                });

                                bucketlistContainer.appendChild(itemDiv);
                            }
                        });

                        map.addLayer(markerClusterGroup);
                    });
                }).catch((error) => {
                    console.error("Error fetching locations:", error);
                });
        }

        function setupFilters() {
            document.getElementById('showBucketlist').addEventListener('change', loadLocations);
            document.getElementById('showVisited').addEventListener('change', loadLocations);

            document.getElementById('bucketlistSearch').addEventListener('input', loadLocations);
        }

        async function toggleVisited(locationId, visited) {
            try {
                const userId = firebase.auth().currentUser.uid;
                const userVisitsRef = db.collection('userVisits');

                if (visited) {
                    await userVisitsRef.add({
                        userId: userId,
                        locationId: locationId,
                        visitedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } else {
                    const visitQuery = await userVisitsRef
                        .where('userId', '==', userId)
                        .where('locationId', '==', locationId)
                        .get();

                    visitQuery.forEach(async (doc) => {
                        await doc.ref.delete();
                    });
                }
                loadLocations();
            } catch (error) {
                console.error("Error updating location:", error);
            }
        }
    </script>
</body>

</html>
